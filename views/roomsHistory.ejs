<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rooms/Games History</title>
    <link rel="stylesheet" href="/dashboard.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <style>
        .main-container {
            display: flex;
            height: 100vh;
            background-color: #f4f7fc;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            margin-left: 20px;
            overflow-y: auto;
        }

        .filter-container {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .filter-container label {
            font-weight: bold;
            margin-right: 10px;
        }

        .filter-container select, 
        .filter-container input {
            padding: 6px 12px;
            border-radius: 4px;
            margin-right: 15px;
        }


        
.player-name {
    font-size: 14px;
    font-weight: bold;
    display: block;
    color: #333;
}

.player-rank {
    font-size: 12px;
    color: #777;
    display: block;
}

.winner-box {
    background: #ffeb3b;
    padding: 6px 12px;
    border-radius: 5px;
    font-weight: 600;
    font-size: 14px;
    text-align: center;
}

.winner-box.empty {
    background: #e0e0e0;
    color: #777;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 5px;
    color: white;
    font-size: 14px;
    font-weight: bold;
    text-align: center;
}

.player-box {
    background: #f9f9f9;
    padding: 6px;
    border-radius: 5px;
    margin-bottom: 5px;
    text-align: center;
    border: 1px solid #ddd;
}
    </style>
</head>
<body>
    <%- include('partials/header') %>

    <div class="main-container d-flex">
        <%- include('partials/sidebar', { page: 'roomsHistory' }) %>

        <div class="col-xl-10 col-lg-10 col-md-10 col-sm-12 col-12 px-4 py-4">
            <h3 class="mb-4">Rooms/Games History</h3>
            
            <div class="card px-3 py-3">
    
                <!-- Filter Section -->
                <div class="filter-container">
                    <label for="gameTypeFilter">Filter by Game Type:</label>
                    <select id="gameTypeFilter">
                        <option value="">All</option>
                        <option value="ludo">Ludo</option>
                        <option value="tournament">Tournament</option>
                    </select>
                    <label for="dateFilter">Filter by Date:</label>
                    <input type="date" id="startDate" />
                    <input type="date" id="endDate" />
                </div>
    
                <!-- Data Table Section -->
                <div class="table-container">
                    <table id="roomsTable" class="display nowrap table-responsive" style="width:100%">
                        <thead>
                            <tr>
                                <th>Room Id</th>
                                <th>Tournament Id</th>
                                <th>Total Bet</th>
                                <th>Commission</th>
                                <th>Entry Fee</th>
                                <th>Players</th>
                                <th>Room Winner</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script>
        $(document).ready(function() {
            var table = $('#roomsTable').DataTable({
                serverSide: true,
                processing: true,
                pageLength: 10,
                dom: 'lBfrtip',
                buttons: ['excelHtml5', 'pdfHtml5'],
                ajax: function(data, callback, settings) {
                    const searchText = data.search.value || '';
                    const gameType = $('#gameTypeFilter').val();
                    const startDate = $('#startDate').val();
                    const endDate = $('#endDate').val();
                    const limit = data.length || 10;
                    const page = Math.floor(data.start / limit) + 1;
                    const orderColumn = data.columns[data.order[0].column].data || 'createdAt';
                    const orderDir = data.order[0].dir || 'desc';
        
                    $.ajax({
                        url: '/api/rooms',
                        method: 'GET',
                        data: {
                            search: searchText,
                            gameType,
                            startDate,
                            endDate,
                            limit,
                            page,
                            orderColumn,
                            orderDir,
                        },
                        success: function(response) {
                            callback({
                                draw: data.draw,
                                recordsTotal: response.totalRecords,
                                recordsFiltered: response.filteredRecords,
                                data: response.rooms
                            });
                        },
                        error: function() {
                            callback({
                                draw: data.draw,
                                recordsTotal: 0,
                                recordsFiltered: 0,
                                data: []
                            });
                        }
                    });
                },
                columns: [
                    { data: 'roomId', title: 'Room Id' },
                    { data: 'tournamentId', title: 'Tournament Id' },
                    { data: 'totalBetAmount', title: 'Total Bet' },
                    { data: 'commission', title: 'Commission', defaultContent: 'N/A' },
                    { data: 'entryFee', title: 'Entry Fee', defaultContent: 'N/A' },
                    {
                        data: 'players',
            title: 'Players',
            render: function (data) {
                return data.map(player =>
                    `<div class="player-box">
                        <span class="player-name">${player.username}</span>
                        <span class="player-rank">${player.rank ? `Score: ${player.score}` : ''}</span>
                    </div>`
                ).join("");
            }
                    },
                    {
                        data: 'winnername',
            title: 'Room Winner',
            render: function (data) {
                return data
                    ? `<div class="winner-box">${data}</div>`
                    : `<div class="winner-box empty">N/A</div>`;
            }
                    },
                    {
                        data: 'status',
            title: 'Status',
            render: function (data) {
                let badgeColor = data === "active" ? "#4CAF50" : data === "completed" ? "#2196F3" : "#F44336";
                return `<div class="status-badge" style="background-color:${badgeColor};">${data}</div>`;
            }
                    }
                ]
            });
        
            $('#gameTypeFilter, #startDate, #endDate').change(function() {
                table.ajax.reload();
            });
        });
        </script>
        
</body>
</html>
