<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Support</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/dashboard.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <style>
        /* Ensure the table layout is fixed and takes full width */
        table {
            table-layout: fixed;
            width: 100% !important;
        }

        /* Button Styling */
        .btn-primary {
            background-color: #007bff;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <%- include('partials/header') %>
    <div class="container-fluid px-0">
        <div class="row">
            <%- include('partials/sidebar', { page: 'support' }) %>

            <div class="col-lg-10 px-4 pt-4">
                <h2>Admin Support Queries</h2>
                <table id="supportTable" class="display table table-striped pt-3">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Mobile</th>
                            <th>Subject</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap Modal for Viewing Query -->
    <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewModalLabel">View Query</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="queryDetails">Loading...</div>
                    <div class="mt-3">
                        <label for="status" class="form-label">Update Status:</label>
                        <select id="status" class="form-select">
                            <option value="Pending">Pending</option>
                            <option value="Resolved">Resolved</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button id="updateStatus" class="btn btn-primary">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            fetchSupportData();
        });

        function fetchSupportData() {
            $('#supportTable').DataTable({
                ajax: '/api/support',
                destroy: true,
                columns: [
                    { data: 'srno' },
                    { data: 'name' },
                    { data: 'email' },
                    { data: 'mobileno' },
                    { data: 'description' },
                    { data: 'status' },
                    {
                        data: 'createdAt',
                        render: function (data) {
                            const date = new Date(data);
                            const day = String(date.getDate()).padStart(2, '0');
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const year = date.getFullYear();
                            return `${day}-${month}-${year}`;
                        }
                    },
                    {
                        data: null,
                        render: function (data) {
                            return `
                                <button class="btn btn-primary btn-sm" onclick="viewQuery(${data.srno})" data-bs-toggle="modal" data-bs-target="#viewModal">View</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteQuery(${data.srno})">Delete</button>
                            `;
                        }
                    }
                ]
            });
        }

        function viewQuery(srno) {
            $.get('/api/support', function (response) {
                const data = response.data.find(item => item.srno == srno);
                if (data) {
                    $('#queryDetails').html(`
                        <p><strong>ID:</strong> ${data.srno}</p>
                        <p><strong>Name:</strong> ${data.name}</p>
                        <p><strong>Email:</strong> ${data.email}</p>
                        <p><strong>Mobile:</strong> ${data.mobileno}</p>
                        <p><strong>Message:</strong> ${data.description}</p>
                        <p><strong>Status:</strong> ${data.status}</p>
                    `);
                    $('#status').val(data.status);

                    $('#updateStatus').off('click').on('click', function () {
                        const newStatus = $('#status').val();
                        $.post('/api/support/update-status', { id: data.srno, status: newStatus }, function (res) {
                            if (res.success) {
                                alert(res.message);
                                $('#viewModal').modal('hide');
                                fetchSupportData();
                            } else {
                                alert('Failed to update status.');
                            }
                        });
                    });
                }
            });
        }

        function deleteQuery(id) {
            if (confirm(`Are you sure you want to delete query ID: ${id}?`)) {
                $.ajax({
                    url: `/api/support/delete/${id}`,
                    type: 'DELETE',
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            fetchSupportData();
                        } else {
                            alert('Failed to delete query.');
                        }
                    },
                    error: function () {
                        alert('An error occurred while deleting the query.');
                    }
                });
            }
        }
    </script>
</body>
</html>
